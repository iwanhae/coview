<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{.ZipName}} - Comic Reader</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
</head>
<body class="bg-black text-white font-sans m-0 p-0">
<div id="viewer" class="w-screen h-screen flex justify-center items-center" onclick="nextPage()">
  <div id="loading-spinner" class="absolute flex justify-center items-center w-full h-full hidden">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
  </div>
  <img id="image" src="" alt="Comic Page" class="max-w-full max-h-full object-contain" onload="hideSpinner()">
</div>
<div id="controls" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 text-center z-10 p-3 bg-black/50 rounded-xl">
  <span id="pageInfo" class="mx-4 cursor-pointer select-none" onclick="toggleModal()"></span>
  <button id="viewOptionsToggle" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-white text-sm ml-2" onclick="toggleViewMode()">Width</button>
  <button id="fullscreenToggle" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-white text-sm ml-2" onclick="toggleFullscreen()">FS</button>
</div>
<div id="preloadStatus" class="hidden fixed bottom-4 right-4 text-xs bg-black/50 text-white px-2 py-1 rounded-md"></div>
<div id="modal" class="hidden fixed z-20 left-0 top-0 w-full h-full bg-black/80" onclick="closeModal(event)">
  <div id="modal-content" class="bg-gray-800 m-auto mt-16 p-5 rounded-xl w-11/12 max-w-md text-center" onclick="event.stopPropagation();">
    <h3 class="text-xl font-bold mb-4">Navigation</h3>
    <button onclick="prevPage(); closeModal({target: {id: 'modal'}});" class="px-4 py-2 mx-2 bg-gray-600 hover:bg-gray-500 rounded text-white">Previous</button>
    <button onclick="nextPage(); closeModal({target: {id: 'modal'}});" class="px-4 py-2 mx-2 bg-gray-600 hover:bg-gray-500 rounded text-white">Next</button>
    <br>
    <label class="block mt-4 mb-2">Go to page:</label>
    <input type="number" id="pageInput" min="1" max="{{len .Files}}" value="1" class="w-20 mx-2 p-1 rounded bg-gray-700 text-white">
    <button onclick="goToPage(); closeModal({target: {id: 'modal'}});" class="px-4 py-1 mt-2 bg-blue-600 hover:bg-blue-500 rounded text-white">Go</button>
    <br>
    <button onclick="closeModal({target: {id: 'modal'}});" class="px-6 py-2 mt-4 bg-gray-500 hover:bg-gray-400 rounded text-white w-full">Close</button>
  </div>
</div>
<div id="error" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center hidden">
  <p class="text-red-300 mb-4">Failed to load image</p>
  <button onclick="retryPage()" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded text-white">Retry</button>
</div>
<script>
let currentPage = 0;
const pages = [{{range $index, $file := .Files}}{{if $index}},{{end}}"{{$file}}"{{end}}];
const totalPages = pages.length;
const zipName = "{{.ZipName}}";
let preloadedPages = new Set();
const PRELOAD_AHEAD = 15;
const MAX_CONCURRENT_PRELOADS = 3;

let preloadSessionId = 0;
let activePreloads = 0;
let preloadQueue = [];
let pagesInQueue = new Set();
let totalForStatus = 0;
let loadedForStatus = 0;
let viewMode = 'width'; // Will be initialized in DOMContentLoaded

function updatePreloadStatus() {
  const statusElement = document.getElementById('preloadStatus');
  if (totalForStatus > 0 && loadedForStatus < totalForStatus) {
    statusElement.classList.remove('hidden');
    statusElement.textContent = `Preloading: ${loadedForStatus} / ${totalForStatus}`;
  } else {
    statusElement.classList.add('hidden');
  }
}

function onPreloadComplete(pageIndex, sessionId) {
    if (sessionId !== preloadSessionId) return; // Ignore stale completions

    activePreloads--;
    loadedForStatus++;
    preloadedPages.add(pageIndex);
    pagesInQueue.delete(pageIndex);
    updatePreloadStatus();
    processPreloadQueue(sessionId);
}

function processPreloadQueue(sessionId) {
    if (sessionId !== preloadSessionId) return; // Ignore stale calls

    while (activePreloads < MAX_CONCURRENT_PRELOADS && preloadQueue.length > 0) {
        const pageIndex = preloadQueue.shift();
        activePreloads++;

        const img = new Image();
        img.src = '/' + zipName + '/' + pages[pageIndex];
        img.onload = () => onPreloadComplete(pageIndex, sessionId);
        img.onerror = () => onPreloadComplete(pageIndex, sessionId);
    }
}

function startPreloading(sessionId) {
  if (sessionId !== preloadSessionId) return; // Ignore stale calls

  const start = currentPage + 1;
  const end = Math.min(start + PRELOAD_AHEAD, totalPages);

  const pagesToQueue = [];
  let alreadyLoadedCount = 0;
  for (let i = start; i < end; i++) {
    if (preloadedPages.has(i)) {
      alreadyLoadedCount++;
    } else if (!pagesInQueue.has(i)) {
      pagesToQueue.push(i);
      pagesInQueue.add(i);
    }
  }

  if (end > start) {
    totalForStatus = end - start;
    loadedForStatus = alreadyLoadedCount;
    updatePreloadStatus();
  }

  if (pagesToQueue.length > 0) {
    preloadQueue.push(...pagesToQueue);
    processPreloadQueue(sessionId);
  }
}

function showSpinner() {
  document.getElementById('loading-spinner').classList.remove('hidden');
  document.getElementById('image').style.opacity = '0.5';
}
function hideSpinner() {
  document.getElementById('loading-spinner').classList.add('hidden');
  document.getElementById('image').style.opacity = '1';
  document.getElementById('image').style.transition = 'opacity 0.15s';
}
function showError() {
  document.getElementById('error').classList.remove('hidden');
  hideSpinner();
}
function retryPage() {
  loadPage(currentPage);
  document.getElementById('error').classList.add('hidden');
}
function loadPage(index) {
  if (index < 0 || index >= totalPages) return;
  currentPage = index;
  const img = document.getElementById('image');
  img.src = '/' + zipName + '/' + pages[index];
  showSpinner();
  document.getElementById('pageInfo').textContent = (currentPage + 1) + ' / ' + totalPages;
  document.getElementById('pageInput').value = currentPage + 1;
  localStorage.setItem('currentPage_' + zipName, currentPage.toString());
  applyViewMode();
  
  // Start a new preloading session, cancelling the previous one.
  preloadSessionId++;
  activePreloads = 0;
  preloadQueue = [];
  pagesInQueue = new Set();
  totalForStatus = 0;
  loadedForStatus = 0;
  updatePreloadStatus(); // Hide status from the old session immediately.

  startPreloading(preloadSessionId);
}
function nextPage() { loadPage(currentPage + 1); }
function prevPage() { loadPage(currentPage - 1); }
function goToPage() {
  const pageNum = parseInt(document.getElementById('pageInput').value) - 1;
  if (!isNaN(pageNum) && pageNum >= 0 && pageNum < totalPages) {
    loadPage(pageNum);
  }
}
function toggleModal() {
  const modal = document.getElementById('modal');
  modal.classList.toggle('hidden');
  if (!modal.classList.contains('hidden')) {
    document.getElementById('pageInput').value = currentPage + 1;
  }
}
function closeModal(event) {
  if (event.target.id === 'modal') {
    document.getElementById('modal').classList.add('hidden');
  }
}
// Enhanced touch/swipe for mobile
let touchStartX = 0;
let touchEndX = 0;
document.addEventListener('touchstart', (e) => {
  touchStartX = e.changedTouches[0].screenX;
}, {passive: true});
document.addEventListener('touchend', (e) => {
  touchEndX = e.changedTouches[0].screenX;
  handleSwipe();
}, {passive: true});
function handleSwipe() {
  const swipeThreshold = 50;
  const diff = touchStartX - touchEndX;
  if (Math.abs(diff) > swipeThreshold) {
    if (diff > 0) {
      nextPage(); // Swipe left
    } else {
      prevPage(); // Swipe right
    }
  }
}
document.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowRight' || e.key === ' ') nextPage();
  if (e.key === 'ArrowLeft') prevPage();
  if (e.key === 'Escape') closeModal({target: {id: 'modal'}});
});

// Fullscreen functionality
function toggleFullscreen() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen().catch(err => {
      console.log(`Error attempting to enable full-screen mode: ${err.message}`);
    });
  } else {
    document.exitFullscreen();
  }
}

function updateFullscreenButton() {
  const btn = document.getElementById('fullscreenToggle');
  if (document.fullscreenElement) {
    btn.innerText = 'Exit';
    btn.classList.remove('bg-gray-600', 'hover:bg-gray-500');
    btn.classList.add('bg-gray-600', 'hover:bg-red-500');
  } else {
    btn.innerText = 'FS';
    btn.classList.remove('bg-gray-600', 'hover:bg-red-500');
    btn.classList.add('bg-gray-600', 'hover:bg-gray-500');
  }
}

document.addEventListener('fullscreenchange', updateFullscreenButton);

// View options functionality
function toggleViewMode() {
  viewMode = viewMode === 'width' ? 'height' : 'width';
  localStorage.setItem('viewMode_' + zipName, viewMode);
  applyViewMode();
  updateViewModeButton();
}

function applyViewMode() {
  const img = document.getElementById('image');
  if (viewMode === 'width') {
    img.className = 'w-full h-auto object-contain';
  } else {
    img.className = 'w-auto h-full object-contain';
  }
}

function updateViewModeButton() {
  const btn = document.getElementById('viewOptionsToggle');
  btn.textContent = viewMode === 'width' ? 'Width' : 'Height';
}

document.addEventListener('DOMContentLoaded', () => {
  // Initialize view mode from localStorage
  viewMode = localStorage.getItem('viewMode_' + zipName) || 'width';
  applyViewMode();
  updateViewModeButton();
  
  const savedPage = localStorage.getItem('currentPage_' + zipName);
  if (savedPage !== null) {
    loadPage(parseInt(savedPage));
  } else {
    loadPage(0);
  }
  updateFullscreenButton();
});
</script>
</body>
</html>
